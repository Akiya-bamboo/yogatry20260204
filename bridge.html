<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>YO → Pose Bridge (Smart Switch)</title>

<style>
body {
  margin: 0;
  background: black;
}

iframe {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  border: none;
}

#poseFrame {
  display: none;
}
</style>
</head>

<body>

<iframe id="yoFrame" src="YO/YO/index.html"></iframe>
<iframe id="poseFrame" src="TRY/TRY/index.html"></iframe>

<script>
const yoFrame = document.getElementById("yoFrame");
const poseFrame = document.getElementById("poseFrame");

let poseLoaded = false;

poseFrame.addEventListener("load", () => {
  poseLoaded = true;
});

function sendStartPose() {
  try {
    poseFrame.contentWindow?.postMessage("START_POSE", "*");
  } catch (_) {}
}

function switchToPose(reason) {
  console.log("Switching to Pose:", reason);

  // 先請登入頁安靜下來，避免語音重疊
  try {
    yoFrame.contentWindow?.postMessage("STOP_VOICE", "*");
  } catch (_) {}

  yoFrame.style.display = "none";
  poseFrame.style.display = "block";

  // 只有在 Pose iframe 準備好之後，才送出 START_POSE 讓它啟動鏡頭與 MediaPipe
  if (poseLoaded) {
    sendStartPose();
  } else {
    const handler = () => {
      poseFrame.removeEventListener("load", handler);
      sendStartPose();
    };
    poseFrame.addEventListener("load", handler);
  }
}

/* ===== 手動測試 ===== */
window.addEventListener("keydown", e => {
  if (e.key === "p") {
    switchToPose("manual key");
  }
});

/* ===== 正式流程：只接受 YO 傳來的 PREP_DONE 後才切換至 Pose ===== */
window.addEventListener("message", event => {
  if (event.source === yoFrame.contentWindow && event.data === "PREP_DONE") {
    switchToPose("PREP_DONE");
  }
});
</script>

</body>
</html>

